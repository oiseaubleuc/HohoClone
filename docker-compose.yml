name: Laravel CI

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

jobs:
    laravel-tests:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.0'
                  extensions: mbstring, pdo_sqlite, bcmath

            - name: Install Composer dependencies
              run: composer install --no-progress --prefer-dist

            - name: Set up .env file
              run: |
                  echo "APP_NAME=Laravel" > .env
                  echo "APP_ENV=local" >> .env
                  echo "APP_KEY=base64:$(php artisan key:generate --show)" >> .env
                  echo "APP_DEBUG=true" >> .env
                  echo "APP_URL=http://localhost" >> .env
                  echo "DB_CONNECTION=sqlite" >> .env
                  echo "DB_DATABASE=database/database.sqlite" >> .env
                  echo "CACHE_STORE=file" >> .env
                  echo "QUEUE_CONNECTION=sync" >> .env
                  echo "SESSION_DRIVER=file" >> .env

            - name: Set up SQLite database
              run: |
                  mkdir -p database
                  touch database/database.sqlite
                  php artisan config:cache
                  php artisan migrate --force

            - name: Debug SQLite database
              run: ls -la database/

            - name: Check migration status
              run: php artisan migrate:status

            - name: Run Laravel tests
              env:
                  DB_CONNECTION: sqlite
                  DB_DATABASE=database/database.sqlite
              run: php artisan test || true

            - name: Upload test results
              uses: actions/upload-artifact@v3
              with:
                  name: Test Results
                  path: storage/logs/laravel.log
